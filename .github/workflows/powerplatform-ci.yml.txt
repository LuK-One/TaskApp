name: Power Platform CI

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Power Platform CLI
        uses: microsoft/powerplatform-actions/setup-pac@v1

      - name: Export and unpack solution
        run: |
          pac auth create --environment ${{ secrets.PP_ENVIRONMENT_URL }} --client-id ${{ secrets.PP_CLIENT_ID }} --client-secret ${{ secrets.PP_CLIENT_SECRET }} --tenant ${{ secrets.PP_TENANT_ID }}
          pac solution export --name ${{ secrets.PP_SOLUTION_NAME }} --outputFolder exported --packageType Unmanaged
          pac solution unpack --zipfile exported/${{ secrets.PP_SOLUTION_NAME }}.zip --folder unpacked

      - name: Commit unpacked changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add unpacked
          git commit -m "Update unpacked solution" || echo "No changes to commit"

      - name: Push changes
        run: |
          git push origin main
